<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameHub</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/bulma.css">
    <link rel="stylesheet" href="/assets/css/fonts.css">
    <style>
        /* æ¸¸æˆè¯¦æƒ…é¡µæ ·å¼ */
        .game-detail {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
        }
        
        .game-header {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .game-thumbnail {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .game-info h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #333;
        }
        
        .game-category {
            background: #007bff;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .game-frame {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            background: #f0f0f0;
        }
        
        .game-description {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .back-button:hover {
            background: #5a6268;
        }
        
        .recommended-games {
            margin-top: 40px;
        }
        
        .recommended-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .recommended-item {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: transform 0.2s;
        }
        
        .recommended-item:hover {
            transform: scale(1.05);
            background: #f8f9fa;
        }
        
        .recommended-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .recommended-item p {
            margin-top: 8px;
            font-size: 0.9em;
            color: #333;
        }

        /* æ¸¸æˆåˆ†ç±»æ ·å¼ */
        .game-categories {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 0;
            margin-bottom: 0;
        }
        
        .category-title {
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 30px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .category-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .category-card.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .category-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
        }
        
        .category-name {
            color: white;
            font-weight: bold;
            font-size: 1em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .categories-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 15px;
            }
            
            .category-card {
                padding: 15px 10px;
            }
            
            .category-icon {
                font-size: 2em;
                margin-bottom: 8px;
            }
            
            .category-name {
                font-size: 0.9em;
            }
            
            .category-title {
                font-size: 2em;
                margin-bottom: 25px;
            }
        }
    </style>
</head>
<body>
    <!-- ä¸»é¡µå†…å®¹ -->
    <div id="homepage">
        <!-- å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="navbar-brand">
                <img src="/assets/img/logo.png" alt="GameHub" style="height: 40px;">
                <span style="margin-left: 10px; font-size: 1.5em; font-weight: bold;">GameHub</span>
            </div>
        </div>

        <!-- Hero åŒºåŸŸ -->
        <div class="hero">
            <div class="hero-body">
                <div class="container has-text-centered">
                    <h1 class="title is-1">GameHub</h1>
                    <h2 class="subtitle">å‘ç°å¹¶æ¸¸ç©ç²¾å½©æ¸¸æˆ</h2>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆåˆ†ç±»åŒºåŸŸ -->
        <div class="game-categories">
            <div class="container">
                <h2 class="category-title">æ¸¸æˆåˆ†ç±»</h2>
                <div class="categories-grid">
                    <div class="category-card" data-category="all">
                        <div class="category-icon">ğŸ®</div>
                        <div class="category-name">å…¨éƒ¨æ¸¸æˆ</div>
                    </div>
                    <div class="category-card" data-category="Shooter">
                        <div class="category-icon">ğŸ”«</div>
                        <div class="category-name">å°„å‡»æ¸¸æˆ</div>
                    </div>
                    <div class="category-card" data-category="Racing">
                        <div class="category-icon">ğŸï¸</div>
                        <div class="category-name">ç«é€Ÿæ¸¸æˆ</div>
                    </div>
                    <div class="category-card" data-category="Puzzle">
                        <div class="category-icon">ğŸ§©</div>
                        <div class="category-name">ç›Šæ™ºæ¸¸æˆ</div>
                    </div>
                    <div class="category-card" data-category="Adventure">
                        <div class="category-icon">ğŸ—ºï¸</div>
                        <div class="category-name">å†’é™©æ¸¸æˆ</div>
                    </div>
                    <div class="category-card" data-category="Action">
                        <div class="category-icon">âš¡</div>
                        <div class="category-name">åŠ¨ä½œæ¸¸æˆ</div>
                    </div>
                    <div class="category-card" data-category="Sports">
                        <div class="category-icon">âš½</div>
                        <div class="category-name">ä½“è‚²æ¸¸æˆ</div>
                    </div>
                    <div class="category-card" data-category="Strategy">
                        <div class="category-icon">ğŸ§ </div>
                        <div class="category-name">ç­–ç•¥æ¸¸æˆ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœç´¢åŒºåŸŸ -->
        <div class="database_nav">
            <div class="container">
                <div class="field">
                    <div class="control">
                        <input class="input is-large" type="text" placeholder="æœç´¢æ¸¸æˆ..." data-func="search">
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆåˆ—è¡¨ -->
        <div class="container">
            <div class="games" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 20px;">
                <!-- æ¸¸æˆå°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- æ¸¸æˆæ¡†æ¶ï¼ˆç”¨äºæ—§ç‰ˆå…¼å®¹ï¼‰ -->
        <div class="gameFrame hidden">
            <!-- è¿™é‡Œä¼šåŠ¨æ€æ’å…¥æ¸¸æˆiframe -->
        </div>
    </div>

    <!-- æ¸¸æˆè¯¦æƒ…é¡µ -->
    <div id="game-detail" class="game-detail">
        <button class="back-button" onclick="goHome()">â† è¿”å›æ¸¸æˆåˆ—è¡¨</button>
        
        <div class="game-header">
            <img id="detail-thumbnail" class="game-thumbnail" src="" alt="">
            <div class="game-info">
                <h1 id="detail-title">æ¸¸æˆæ ‡é¢˜</h1>
                <span id="detail-category" class="game-category">åˆ†ç±»</span>
                <p id="detail-description-short">æ¸¸æˆç®€ä»‹...</p>
            </div>
        </div>
        
        <iframe id="game-iframe" class="game-frame" src=""></iframe>
        
        <div class="game-description">
            <h3>æ¸¸æˆè¯´æ˜</h3>
            <p id="detail-description-full">è¯¦ç»†æ¸¸æˆè¯´æ˜...</p>
        </div>
        
        <div class="recommended-games">
            <h3>æ¨èæ¸¸æˆ</h3>
            <div id="recommended-grid" class="recommended-grid">
                <!-- æ¨èæ¸¸æˆå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- åŠ è½½ç°æœ‰çš„JSæ–‡ä»¶ -->
    <script type="module" src="/assets/js/gamemanger.js"></script>
    <script type="module" src="/assets/js/notification.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let allGames = [];
        let currentGame = null;

        // ç®€å•çš„slugç”Ÿæˆå‡½æ•°
        function generateSlug(name) {
            return name.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '')
                .trim();
        }

        // æ¸²æŸ“æ¸¸æˆåˆ—è¡¨å‡½æ•° - ç¡®ä¿å…¨å±€å¯ç”¨
        function renderGames(games) {
            const gamesContainer = document.querySelector('.games');
            if (!gamesContainer) return;
            
            gamesContainer.innerHTML = '';

            games.forEach(game => {
                const gameEl = document.createElement('div');
                gameEl.classList = 'game';
                gameEl.title = game.name;
                gameEl.innerHTML = `
                    <img src="${game.thumbnail || '/assets/img/logo.png'}" alt="${game.name}"/>
                    <p>${game.name}</p>
                `;
                gamesContainer.appendChild(gameEl);

                gameEl.querySelector('img').onerror = (e) => {
                    e.target.src = '/assets/img/logo.png';
                };

                gameEl.addEventListener('click', () => {
                    if (window.openGame) {
                        window.openGame(game.id);
                    }
                });
            });
        }

        // æš´éœ²renderGamesåˆ°å…¨å±€
        window.renderGames = renderGames;

        // æ”¹è¿›çš„è·¯ç”±å¤„ç† - æ›¿æ¢åŸæ¥çš„ handleRoute å‡½æ•°
        function handleRoute() {
            const path = window.location.pathname;
            
            // æ¸¸æˆè¯¦æƒ…é¡µè·¯ç”±: /game/game-slug
            if (path.startsWith('/game/')) {
                const gameSlug = path.replace('/game/', '');
                showGameDetail(gameSlug);
                return;
            }
            
            // åˆ†ç±»é¡µé¢è·¯ç”±: /category/category-name
            if (path.startsWith('/category/')) {
                const category = path.replace('/category/', '');
                showCategoryPage(category);
                return;
            }
            
            // å…¼å®¹æ—§çš„åˆ†ç±»è·¯ç”±: /shooter, /racing ç­‰
            if (path !== '/' && path !== '/index.html' && !path.includes('.')) {
                const category = path.slice(1);
                showCategoryPage(category);
                return;
            }
            
            // é»˜è®¤ä¸»é¡µè·¯ç”±
            showHomepage();
        }

        // æ˜¾ç¤ºä¸»é¡µ
        function showHomepage() {
            document.getElementById('homepage').style.display = 'block';
            if (document.getElementById('game-detail')) {
                document.getElementById('game-detail').style.display = 'none';
            }
            if (document.getElementById('game-iframe')) {
                document.getElementById('game-iframe').style.display = 'none';
            }
            document.title = 'GameHub';

            // é‡ç½®åˆ†ç±»é€‰æ‹©çŠ¶æ€
            const categoryCards = document.querySelectorAll('.category-card');
            categoryCards.forEach(c => c.classList.remove('active'));
            const allCard = document.querySelector('[data-category="all"]');
            if (allCard) allCard.classList.add('active');

            // æ˜¾ç¤ºæ‰€æœ‰æ¸¸æˆ
            if (window.GAMES && window.GAMES.length > 0) {
                renderGames(window.GAMES);
                updateSearchPlaceholder('all', window.GAMES.length);
            }
        }

        // æ˜¾ç¤ºåˆ†ç±»é¡µé¢
        function showCategoryPage(category) {
            console.log('æ˜¾ç¤ºåˆ†ç±»é¡µé¢:', category);
            
            document.getElementById('homepage').style.display = 'block';
            if (document.getElementById('game-detail')) {
                document.getElementById('game-detail').style.display = 'none';
            }
            if (document.getElementById('game-iframe')) {
                document.getElementById('game-iframe').style.display = 'none';
            }

            // ç­‰å¾…æ¸¸æˆæ•°æ®åŠ è½½
            if (!window.GAMES || !window.GAMES.length) {
                console.log('ç­‰å¾…æ¸¸æˆæ•°æ®åŠ è½½...');
                setTimeout(() => showCategoryPage(category), 100);
                return;
            }

            // æ£€æŸ¥åˆ†ç±»æ˜¯å¦æœ‰æ•ˆ
            const validCategories = ['shooter', 'racing', 'puzzle', 'adventure', 'action', 'sports', 'strategy'];
            const normalizedCategory = category.toLowerCase();

            if (!validCategories.includes(normalizedCategory)) {
                console.warn('æ— æ•ˆçš„åˆ†ç±»:', category);
                window.history.replaceState(null, '', '/');
                showHomepage();
                return;
            }

            // æ›´æ–°åˆ†ç±»é€‰æ‹©çŠ¶æ€
            const categoryCards = document.querySelectorAll('.category-card');
            categoryCards.forEach(c => c.classList.remove('active'));

            // æŸ¥æ‰¾å¯¹åº”çš„åˆ†ç±»å¡ç‰‡å¹¶æ¿€æ´»
            const targetCard = document.querySelector(`[data-category="${category}"]`) ||
                              document.querySelector(`[data-category="${category.charAt(0).toUpperCase() + category.slice(1)}"]`);
            if (targetCard) {
                targetCard.classList.add('active');
                console.log('æ¿€æ´»åˆ†ç±»å¡ç‰‡:', targetCard.dataset.category);
            }

            // è¿‡æ»¤å¹¶æ˜¾ç¤ºå¯¹åº”åˆ†ç±»çš„æ¸¸æˆ
            filterGamesByCategory(category);

            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const categoryName = getCategoryName(category);
            document.title = `${categoryName}æ¸¸æˆ - GameHub`;
        }

        // åˆ†ç±»ç­›é€‰åŠŸèƒ½
        function filterGamesByCategory(category) {
            console.log('ç­›é€‰åˆ†ç±»:', category, 'æ¸¸æˆæ€»æ•°:', window.GAMES?.length);
            
            if (!window.GAMES) return;

            let filteredGames;
            if (category === 'all') {
                filteredGames = window.GAMES;
            } else {
                // ç²¾ç¡®åŒ¹é…åˆ†ç±»
                filteredGames = window.GAMES.filter(game => {
                    if (!game.category) return false;
                    const gameCategory = game.category.toLowerCase();
                    const targetCategory = category.toLowerCase();
                    return gameCategory === targetCategory;
                });
            }

            console.log('ç­›é€‰ç»“æœ:', filteredGames.length, 'ä¸ªæ¸¸æˆ');
            
            // æ¸²æŸ“æ¸¸æˆ
            renderGames(filteredGames);
            updateSearchPlaceholder(category, filteredGames.length);
        }

        // åˆ†ç±»ç­›é€‰åŠŸèƒ½åˆå§‹åŒ–
        function initCategoryFilter() {
            const categoryCards = document.querySelectorAll('.category-card');
            console.log('åˆå§‹åŒ–åˆ†ç±»ç­›é€‰ï¼Œæ‰¾åˆ°', categoryCards.length, 'ä¸ªåˆ†ç±»å¡ç‰‡');

            categoryCards.forEach(card => {
                card.addEventListener('click', (e) => {
                    e.preventDefault();
                    const category = card.dataset.category;
                    console.log('ç‚¹å‡»åˆ†ç±»:', category);
                    navigateToCategory(category);
                });
            });
        }

         // å¯¼èˆªåˆ°åˆ†ç±»é¡µé¢ - æ›¿æ¢åŸæ¥çš„ navigateToCategory å‡½æ•°
         function navigateToCategory(category) {
            if (category === 'all') {
                window.history.pushState(null, '', '/');
                showHomepage();
            } else {
                const categoryPath = `/category/${category.toLowerCase()}`;
                window.history.pushState(null, '', categoryPath);
                showCategoryPage(category);
            }
        }

        function updateSearchPlaceholder(category, count) {
            const searchBar = document.querySelector('[data-func="search"]');
            if (!searchBar) return;

            if (category === 'all') {
                searchBar.placeholder = `æœç´¢ ${count} ä¸ªæ¸¸æˆ`;
            } else {
                searchBar.placeholder = `æœç´¢ ${count} ä¸ª${getCategoryName(category)}æ¸¸æˆ`;
            }
        }
        
        function getCategoryName(category) {
            const categoryMap = {
                'shooter': 'å°„å‡»',
                'racing': 'ç«é€Ÿ', 
                'puzzle': 'ç›Šæ™º',
                'adventure': 'å†’é™©',
                'action': 'åŠ¨ä½œ',
                'sports': 'ä½“è‚²',
                'strategy': 'ç­–ç•¥'
            };
            return categoryMap[category.toLowerCase()] || category;
        }

        // æ˜¾ç¤ºæ¸¸æˆè¯¦æƒ…é¡µ
        // ä¿®æ”¹showGameDetailå‡½æ•°ä½¿ç”¨ä»£ç†
               function showGameDetail(gameSlug) {
            if (!window.GAMES || !window.GAMES.length) {
                setTimeout(() => showGameDetail(gameSlug), 100);
                return;
            }

            const game = window.GAMES.find(g => generateSlug(g.name) === gameSlug);
            if (!game) {
                console.error('æ¸¸æˆæœªæ‰¾åˆ°:', gameSlug);
                goHome();
                return;
            }

            currentGame = game;
            
            // æ˜¾ç¤ºè¯¦æƒ…é¡µ
            document.getElementById('homepage').style.display = 'none';
            document.getElementById('game-detail').style.display = 'block';
            
            // æ›´æ–°æ¸¸æˆä¿¡æ¯
            document.getElementById('detail-title').textContent = game.name;
            document.getElementById('detail-thumbnail').src = game.thumbnail || '/assets/img/logo.png';
            document.getElementById('detail-category').textContent = game.category || 'æ¸¸æˆ';
            document.getElementById('detail-description-short').textContent = game.description || 'æš‚æ— æè¿°';
            document.getElementById('detail-description-full').textContent = game.instructions || game.description || 'æš‚æ— è¯¦ç»†è¯´æ˜';
            
            // ä½¿ç”¨ä»£ç†åŠ è½½æ¸¸æˆ
            const iframe = document.getElementById('game-iframe');
            if (iframe) {
                const proxyUrl = `/assets/pages/proxy-frame.html?url=${encodeURIComponent(game.url)}`;
                iframe.src = proxyUrl;
                iframe.style.display = 'block';
            }
            
            document.title = `${game.name} - GameHub`;
            generateRecommendedGames();
        }

        // ç”Ÿæˆæ¨èæ¸¸æˆ
        function generateRecommendedGames() {
            const grid = document.getElementById('recommended-grid');
            if (!grid || !currentGame) return;
            
            grid.innerHTML = '';
            
            if (!window.GAMES) return;
            
            // è·å–åŒåˆ†ç±»çš„å…¶ä»–æ¸¸æˆ
            let recommended = window.GAMES.filter(g => 
                g.category === currentGame.category && g.id !== currentGame.id
            ).slice(0, 6);
            
            if (recommended.length < 6) {
                const others = window.GAMES.filter(g => 
                    g.id !== currentGame.id && !recommended.includes(g)
                ).slice(0, 6 - recommended.length);
                recommended = [...recommended, ...others];
            }
            
            recommended.forEach(game => {
                const item = document.createElement('div');
                item.className = 'recommended-item';
                item.innerHTML = `
                    <img src="${game.thumbnail || '/assets/img/logo.png'}" alt="${game.name}">
                    <p>${game.name}</p>
                `;
                item.onclick = () => navigateToGame(game.name);
                grid.appendChild(item);
            });
        }

        // å¯¼èˆªåˆ°æ¸¸æˆ
        function navigateToGame(gameName) {
            const slug = generateSlug(gameName);
            const gamePath = `/game/${slug}`;
            window.history.pushState(null, '', gamePath);
            showGameDetail(slug);
        }

        // é‡å†™æ¸¸æˆç‚¹å‡»äº‹ä»¶ï¼ˆè¦†ç›–gamemanger.jsä¸­çš„openGameå‡½æ•°ï¼‰
        window.openGame = function(id) {
            if (!window.GAMES) return;
            const game = window.GAMES.find(g => g.id === id);
            if (game) {
                navigateToGame(game.name);
            }
        };

        // è¿”å›ä¸»é¡µ
        function goHome() {
            window.history.pushState(null, '', '/');
            showHomepage();
        }

        // äº‹ä»¶ç›‘å¬
        window.addEventListener('hashchange', handleRoute);
        window.addEventListener('popstate', handleRoute); // æ”¯æŒæµè§ˆå™¨å‰è¿›åé€€
        
        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // ç­‰å¾…gamemanger.jsåŠ è½½å®Œæˆåå¤„ç†è·¯ç”±å’Œåˆå§‹åŒ–åˆ†ç±»ç­›é€‰
            setTimeout(() => {
                console.log('å¼€å§‹å¤„ç†è·¯ç”±å’Œåˆå§‹åŒ–åˆ†ç±»ç­›é€‰');
                handleRoute();
                initCategoryFilter();
            }, 1000); // å¢åŠ ç­‰å¾…æ—¶é—´ç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
        });

        // æš´éœ²å…¨å±€å‡½æ•°
        window.navigateToGame = navigateToGame;
        window.generateSlug = generateSlug;
        window.handleRoute = handleRoute;
        window.showCategoryPage = showCategoryPage;
        window.filterGamesByCategory = filterGamesByCategory;
    </script>
</body>
</html>